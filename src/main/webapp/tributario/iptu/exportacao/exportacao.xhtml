<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//PT"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:fc="http://java.sun.com/jsf/composite/components"
      xmlns:fct="http://java.sun.com/jsf/composite/components/tributario"
      xmlns:p="http://primefaces.org/ui"
>
<ui:composition template="/corpo.xhtml">
    <ui:define name="body">
        <script type="text/javascript">
            var timer;

            function iniciaExportacao() {
                timer = setInterval(function () {
                    posExportacao();
                }, 1000);

            }

            function terminaExportacao() {
                clearInterval(timer);
            }

            function terminaExportacaoSemIPTU() {
                clearInterval(timer);
                dialog.hide();
            }
        </script>
        <h:form id="Formulario">
            <p:remoteCommand name="posExportacao" actionListener="#{exportacaoIPTUControlador.posExportacao}"
                             update="Formulario:primeiraTab:panel-rodape"/>
            <p:panel header="Exportação de IPTU" styleClass="mbot05">

                <p:tabView id="primeiraTab" styleClass="mtop10"
                           activeIndex="#{exportacaoIPTUControlador.activeTabIndex}">
                    <p:tab title="Nova Exportação"
                           id="novaExportacaoTab">

                        <p:panel rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso == null}">
                            <h:panelGrid columns="4">
                                <h:outputText value="Inscrição Cadastral:"/>
                                <fct:intervaloInscricaoCadastral tipoCadastroTributario="IMOBILIARIO"
                                                                 inscricaoCadastralInicial="#{exportacaoIPTUControlador.selecionado.inscricaoInicial}"
                                                                 inscricaoCadastralFinal="#{exportacaoIPTUControlador.selecionado.inscricaoFinal}"/>

                                <h:outputText value="Exercício:"/>
                                <p:inputText value="#{exportacaoIPTUControlador.selecionado.exercicio}"
                                             converter="#{exercicioControlador.converterExercicio}"
                                             maxlength="4" size="10"/>

                                <h:outputText value="Imóveis:"/>

                                <h:selectOneMenu value="#{exportacaoIPTUControlador.selecionado.tipoImovel}">
                                    <f:selectItems value="#{exportacaoIPTUControlador.tiposImoveis}"/>
                                </h:selectOneMenu>

                                <h:outputText value="Valor Inicial do IPTU:"/>
                                <p:inputText value="#{exportacaoIPTUControlador.selecionado.valorInicial}"
                                             maxlength="12"
                                             size="18">
                                    <f:convertNumber pattern="###,##0.00"/>
                                </p:inputText>

                                <h:outputText value="Valor Final do IPTU:"/>
                                <p:inputText value="#{exportacaoIPTUControlador.selecionado.valorFinal}" maxlength="12"
                                             size="18">
                                    <f:convertNumber pattern="###,##0.00"/>
                                </p:inputText>

                                <h:outputText value="Exporta IPTU impressos:"/>
                                <p:selectBooleanCheckbox
                                    value="#{exportacaoIPTUControlador.selecionado.geraParcelasJaImpressas}"/>

                                <h:outputText value="Endereço de entrega:"/>
                                <h:panelGrid columns="2">
                                    <h:selectOneMenu value="#{exportacaoIPTUControlador.selecionado.tipoEndereco}">
                                        <f:selectItems value="#{exportacaoIPTUControlador.tiposEnderecos}"/>
                                    </h:selectOneMenu>
                                    <p:commandButton process="@none"
                                                     update="@none"
                                                     id="bt-informacao"
                                                     styleClass="icone-20 mrig05"
                                                     icon="ui-icon-info"/>

                                    <p:overlayPanel for="bt-informacao"
                                                    style="border : solid black 1px;"
                                                    styleClass="semSombra"
                                                    showEvent="mouseover"
                                                    hideEvent="mouseout">
                                        <h:outputText
                                            value="Caso não seja informado o tipo de endereço, por padrão, será adicionado o endereço do imóvel."
                                            escape="false"/>
                                    </p:overlayPanel>
                                </h:panelGrid>

                                <h:outputText value="Quantidade Parcelas Inicial:"/>
                                <fc:inputInteiro
                                    value="#{exportacaoIPTUControlador.selecionado.quantidadeParcelasInicial}"
                                    style=""/>

                                <h:outputText value="Quantidade Parcelas Final:"/>
                                <fc:inputInteiro
                                    value="#{exportacaoIPTUControlador.selecionado.quantidadeParcelasFinal}"
                                    style=""/>

                                <h:outputText value="Novo sequencial:"/>
                                <h:panelGrid columns="2">
                                    <p:selectBooleanCheckbox
                                        value="#{exportacaoIPTUControlador.selecionado.novoSequencial}"/>
                                    <p:commandButton process="@none"
                                                     update="@none"
                                                     id="bt-informacao-sequencial"
                                                     styleClass="icone-20 mrig05"
                                                     icon="ui-icon-info"/>

                                    <p:overlayPanel for="bt-informacao-sequencial"
                                                    style="border : solid black 1px;"
                                                    styleClass="semSombra"
                                                    showEvent="mouseover"
                                                    hideEvent="mouseout">
                                        <h:outputText
                                            value="Caso esteja desmarcado, o sequencial de quantidade de cadastros exportados continuará a partir do sequencial da última exportação feita,
                                            e caso esteja marcado, o sequencial do arquivo começará do número 1."
                                            escape="false"/>
                                    </p:overlayPanel>
                                </h:panelGrid>
                            </h:panelGrid>

                            <p:tabView id="tabGeral" styleClass="mtop10">
                                <p:tab title="Inscrições Imobiliárias Ignoradas"
                                       id="panelInscIgnoradas">

                                    <h:panelGrid columns="2">
                                        <h:outputText value="Setor: "/>
                                        <h:panelGroup id="setoresIPTU">
                                            <table class="table table-striped">
                                                <ui:repeat
                                                    value="#{exportacaoIPTUControlador.selecionado.setores}"
                                                    var="setor">
                                                    <tr>
                                                        <td>
                                                            <h:outputText value="#{setor.nome}"
                                                                          styleClass="negrito"/>
                                                        </td>
                                                        <td style="text-align: right">
                                                            <p:commandButton icon="ui-icon-trash"
                                                                             styleClass="botao-transparente"
                                                                             onstart="aguarde.show()"
                                                                             oncomplete="aguarde.hide()"
                                                                             actionListener="#{exportacaoIPTUControlador.removerSetor(setor)}"
                                                                             process="@this"
                                                                             update="@form"/>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                                <tr>
                                                    <td colspan="2">
                                                        <p:autoComplete queryDelay="1000"
                                                                        id="setorImobiliario"
                                                                        title="Selecione o Setor"
                                                                        value="#{exportacaoIPTUControlador.selecionado.setor}"
                                                                        completeMethod="#{exportacaoIPTUControlador.completarSetor}"
                                                                        var="setor"
                                                                        size="40"
                                                                        itemLabel="#{setor.nome}"
                                                                        itemValue="#{setor.id}"
                                                                        forceSelection="true"
                                                                        converter="#{setorControlador.converterGenerico}">
                                                            <p:ajax event="itemSelect"
                                                                    process="@this"
                                                                    update="setoresIPTU"
                                                                    listener="#{exportacaoIPTUControlador.adicionarSetor()}"/>
                                                        </p:autoComplete>
                                                    </td>
                                                </tr>
                                            </table>
                                        </h:panelGroup>

                                        <h:outputText value="Lote: "/>
                                        <h:panelGroup id="lotesIPTU">
                                            <table class="table table-striped">
                                                <ui:repeat
                                                    value="#{exportacaoIPTUControlador.selecionado.lotes}"
                                                    var="lote">
                                                    <tr>
                                                        <td>
                                                            <h:outputText value="#{lote.codigoLote}"
                                                                          styleClass="negrito"/>
                                                        </td>
                                                        <td style="text-align: right">
                                                            <p:commandButton icon="ui-icon-trash"
                                                                             styleClass="botao-transparente"
                                                                             onstart="aguarde.show()"
                                                                             oncomplete="aguarde.hide()"
                                                                             actionListener="#{exportacaoIPTUControlador.removerLote(lote)}"
                                                                             process="@this"
                                                                             update="@form"/>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                                <tr>
                                                    <td colspan="2">
                                                        <p:autoComplete queryDelay="1000"
                                                                        id="loteImobiliario"
                                                                        title="Selecione o Lote"
                                                                        value="#{exportacaoIPTUControlador.selecionado.lote}"
                                                                        completeMethod="#{exportacaoIPTUControlador.completarLote}"
                                                                        var="lote"
                                                                        size="40"
                                                                        itemLabel="#{lote.codigoLote}"
                                                                        itemValue="#{lote.id}"
                                                                        forceSelection="true"
                                                                        converter="#{loteControlador.converterLote}">
                                                            <p:ajax event="itemSelect"
                                                                    process="@this"
                                                                    update="lotesIPTU"
                                                                    listener="#{exportacaoIPTUControlador.adicionarLote()}"/>
                                                        </p:autoComplete>
                                                    </td>
                                                </tr>
                                            </table>
                                        </h:panelGroup>

                                        <h:outputText value="Quadra: "/>
                                        <h:panelGroup id="qaudrasIPTU">
                                            <table class="table table-striped">
                                                <ui:repeat
                                                    value="#{exportacaoIPTUControlador.selecionado.quadras}"
                                                    var="quadra">
                                                    <tr>
                                                        <td>
                                                            <h:outputText value="#{quadra.descricao}"
                                                                          styleClass="negrito"/>
                                                        </td>
                                                        <td style="text-align: right">
                                                            <p:commandButton icon="ui-icon-trash"
                                                                             styleClass="botao-transparente"
                                                                             onstart="aguarde.show()"
                                                                             oncomplete="aguarde.hide()"
                                                                             actionListener="#{exportacaoIPTUControlador.removerQuadra(quadra)}"
                                                                             process="@this"
                                                                             update="@form"/>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                                <tr>
                                                    <td colspan="2">
                                                        <p:autoComplete queryDelay="1000"
                                                                        id="quadraImobiliario"
                                                                        title="Selecione a Quadra"
                                                                        value="#{exportacaoIPTUControlador.selecionado.quadra}"
                                                                        completeMethod="#{exportacaoIPTUControlador.completarQuadra}"
                                                                        var="quadra"
                                                                        size="40"
                                                                        itemLabel="#{quadra.descricao}"
                                                                        itemValue="#{quadra.id}"
                                                                        forceSelection="true"
                                                                        converter="#{quadraControlador.converterGenerico}">
                                                            <p:ajax event="itemSelect"
                                                                    process="@this"
                                                                    update="qaudrasIPTU"
                                                                    listener="#{exportacaoIPTUControlador.adicionarQuadra()}"/>
                                                        </p:autoComplete>
                                                    </td>
                                                </tr>
                                            </table>
                                        </h:panelGroup>

                                        <h:outputText value="Bairro: "/>
                                        <h:panelGroup id="bairrosIPTU">
                                            <table class="table table-striped">
                                                <ui:repeat
                                                    value="#{exportacaoIPTUControlador.selecionado.bairros}"
                                                    var="bairro">
                                                    <tr>
                                                        <td>
                                                            <h:outputText value="#{bairro}"
                                                                          styleClass="negrito"/>
                                                        </td>
                                                        <td style="text-align: right">
                                                            <p:commandButton icon="ui-icon-trash"
                                                                             styleClass="botao-transparente"
                                                                             onstart="aguarde.show()"
                                                                             oncomplete="aguarde.hide()"
                                                                             actionListener="#{exportacaoIPTUControlador.removerBairro(bairro)}"
                                                                             process="@this"
                                                                             update="@form"/>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                                <tr>
                                                    <td colspan="2">
                                                        <p:autoComplete queryDelay="1000"
                                                                        id="bairroImobiliario"
                                                                        title="Selecione o Bairro"
                                                                        value="#{exportacaoIPTUControlador.selecionado.bairro}"
                                                                        completeMethod="#{exportacaoIPTUControlador.completarBairro}"
                                                                        var="bairro"
                                                                        size="70"
                                                                        itemLabel="#{bairro}" itemValue="#{bairro.id}"
                                                                        forceSelection="true"
                                                                        converter="#{bairroControlador.converterGenerico}">
                                                            <p:ajax event="itemSelect"
                                                                    process="@this"
                                                                    update="bairrosIPTU"
                                                                    listener="#{exportacaoIPTUControlador.adicionarBairro()}"/>
                                                        </p:autoComplete>
                                                    </td>
                                                </tr>
                                            </table>
                                        </h:panelGroup>

                                        <h:outputText value="Logradouro: "/>
                                        <h:panelGroup id="logradouroIPTU">
                                            <table class="table table-striped" cellpadding="0" cellspacing="0">
                                                <ui:repeat
                                                    value="#{exportacaoIPTUControlador.selecionado.logradouros}"
                                                    var="logradouro">
                                                    <tr>
                                                        <td>
                                                            <h:outputText value="#{logradouro}"
                                                                          styleClass="negrito"/>
                                                        </td>
                                                        <td style="text-align: right">
                                                            <p:commandButton icon="ui-icon-trash"
                                                                             styleClass="botao-transparente"
                                                                             onstart="aguarde.show()"
                                                                             oncomplete="aguarde.hide()"
                                                                             actionListener="#{exportacaoIPTUControlador.removerLogradouro(logradouro)}"
                                                                             process="@this"
                                                                             update="@form"/>
                                                        </td>
                                                    </tr>
                                                </ui:repeat>
                                                <tr>
                                                    <td colspan="2">
                                                        <p:autoComplete queryDelay="1000"
                                                                        id="logradouroImobiliario"
                                                                        title="Selecione o Logradouro"
                                                                        value="#{exportacaoIPTUControlador.selecionado.logradouro}"
                                                                        completeMethod="#{exportacaoIPTUControlador.completarLogradouro}"
                                                                        var="logradouro"
                                                                        size="70"
                                                                        itemLabel="#{logradouro}"
                                                                        itemValue="#{logradouro.id}"
                                                                        forceSelection="true"
                                                                        converter="#{logradouroControlador.converterGenerico}">
                                                            <p:ajax event="itemSelect"
                                                                    process="@this"
                                                                    update="logradouroIPTU"
                                                                    listener="#{exportacaoIPTUControlador.adicionarLogradouro()}"/>
                                                        </p:autoComplete>
                                                    </td>
                                                </tr>
                                            </table>
                                        </h:panelGroup>

                                        <h:outputText value="Cadastros com Número Inválido:"/>
                                        <p:selectBooleanCheckbox
                                            value="#{exportacaoIPTUControlador.selecionado.cadastrosNumeroInvalido}">
                                            <p:ajax process="@this"
                                                    update=":Formulario:primeiraTab:tabGeral:tabViewInscricao:panelImoveis"/>

                                        </p:selectBooleanCheckbox>

                                        <h:outputText value="Cadastros com CEP Inválido:"/>
                                        <p:selectBooleanCheckbox
                                            value="#{exportacaoIPTUControlador.selecionado.cadastrosCepInvalido}">
                                            <p:ajax process="@this"
                                                    update=":Formulario:primeiraTab:tabGeral:tabViewInscricao:panelImoveis"/>

                                        </p:selectBooleanCheckbox>

                                        <p:commandButton value="Buscar"
                                                         onclick="aguarde.show()"
                                                         oncomplete="aguarde.hide();"
                                                         styleClass="operacao padrao mtop05"
                                                         icon="ui-icon-search"
                                                         process="@form"
                                                         update="@form"
                                                         actionListener="#{exportacaoIPTUControlador.buscarCadastrosIgnorados()}">
                                        </p:commandButton>

                                    </h:panelGrid>

                                    <p:tabView id="tabViewInscricao" styleClass="mtop10">
                                        <p:tab title="Relação de Imóveis Pesquisados" id="panel">

                                            <p:outputPanel id="panelImoveis">

                                                <p:dataTable id="tabelaIgnorados"
                                                             paginator="true"
                                                             var="cadastro"
                                                             rows="10"
                                                             paginatorTemplate="{CurrentPageReport}  &lt;span class='titulo-tabela mrig10'>RELAÇÃO DE IMÓVEIS PESQUISADOS&lt;/span> {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                             rowsPerPageTemplate="30,60,90"
                                                             value="#{exportacaoIPTUControlador.selecionado.cadastros}"
                                                             emptyMessage="Nenhum Registro encontrado!">


                                                    <p:column styleClass="centralizado" style="width: 5%">

                                                        <f:facet name="header">

                                                            <p:commandButton icon="ui-icon-check"
                                                                             styleClass="vinteLarguraVinteAltura"
                                                                             update="tabelaIgnorados"
                                                                             process="@this"
                                                                             onstart="aguarde.show();"
                                                                             oncomplete="aguarde.hide();"
                                                                             title="Desmarcar Todos"
                                                                             rendered="#{exportacaoIPTUControlador.todosItensMarcados}"
                                                                             actionListener="#{exportacaoIPTUControlador.setTodosItensMarcados(false)}"/>

                                                            <p:commandButton
                                                                styleClass="vinteLarguraVinteAltura ui-icon-none"
                                                                value=""
                                                                process="@this"
                                                                onstart="aguarde.show();"
                                                                oncomplete="aguarde.hide();"
                                                                update="tabelaIgnorados"
                                                                title="Marcar Todos"
                                                                rendered="#{!exportacaoIPTUControlador.todosItensMarcados}"
                                                                actionListener="#{exportacaoIPTUControlador.setTodosItensMarcados(true)}"/>
                                                        </f:facet>

                                                        <p:commandButton icon="ui-icon-check"
                                                                         styleClass="vinteLarguraVinteAltura"
                                                                         update="tabelaIgnorados"
                                                                         process="@this"
                                                                         onstart="aguarde.show();"
                                                                         oncomplete="aguarde.hide();"
                                                                         rendered="#{!exportacaoIPTUControlador.hasCadastroIgnorado(cadastro)}"
                                                                         actionListener="#{exportacaoIPTUControlador.desmarcarCadastroIgnorado(cadastro)}"/>

                                                        <p:commandButton
                                                            styleClass="vinteLarguraVinteAltura botao-select-desmarcado"
                                                            update="tabelaIgnorados"
                                                            process="@this"
                                                            value=""
                                                            onstart="aguarde.show();"
                                                            oncomplete="aguarde.hide();"
                                                            rendered="#{exportacaoIPTUControlador.hasCadastroIgnorado(cadastro)}"
                                                            actionListener="#{exportacaoIPTUControlador.marcarCadastroIgnorado(cadastro)}"/>
                                                    </p:column>

                                                    <p:column headerText="Inscrição Imobiliária">
                                                        <h:outputText value="#{cadastro.inscricaoCadastral}"/>
                                                    </p:column>
                                                    <p:column headerText="Setor">
                                                        <h:outputText
                                                            value="#{cadastro.setor}"/>
                                                    </p:column>
                                                    <p:column headerText="Lote">
                                                        <h:outputText
                                                            value="#{cadastro.lote}"/>
                                                    </p:column>
                                                    <p:column headerText="Quadra">
                                                        <h:outputText
                                                            value="#{cadastro.quadra}"/>
                                                    </p:column>
                                                    <p:column headerText="Bairro">
                                                        <h:outputText
                                                            value="#{cadastro.bairro}"/>
                                                    </p:column>
                                                    <p:column headerText="Logradouro">
                                                        <h:outputText
                                                            value="#{cadastro.logradouro}"/>
                                                    </p:column>
                                                    <p:column headerText="Número" style="width: 2%">
                                                        <h:outputText value="#{cadastro.numero}"/>
                                                    </p:column>
                                                </p:dataTable>

                                                <p:commandButton id="botao-adicionar-ignorados"
                                                                 icon="ui-icon-check"
                                                                 onclick="aguarde.show()"
                                                                 process="@this"
                                                                 update=":Formulario:primeiraTab:tabGeral:tabViewInscricao:panelImoveisIgnorados"
                                                                 oncomplete="aguarde.hide()"
                                                                 value="Adicionar Selecionados"
                                                                 disabled="#{!exportacaoIPTUControlador.isCadastrosImobiliariosPesquisados()}"
                                                                 actionListener="#{exportacaoIPTUControlador.adicionarCadastrosPesquisados()}"
                                                                 styleClass="operacao padrao mtop10"/>
                                            </p:outputPanel>
                                        </p:tab>

                                        <p:tab title="Relação de Imóveis Ignorados" id="panelIgnorados">

                                            <p:outputPanel id="panelImoveisIgnorados">

                                                <p:dataTable id="tabelaCadastrosIgnorados"
                                                             paginator="true"
                                                             var="cadastro"
                                                             rows="10"
                                                             paginatorTemplate="{CurrentPageReport}  &lt;span class='titulo-tabela mrig10'>RELAÇÃO DE IMÓVEIS IGNORADOS&lt;/span> {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                                             rowsPerPageTemplate="30,60,90"
                                                             value="#{exportacaoIPTUControlador.selecionado.cadastrosIgnorados}"
                                                             emptyMessage="Nenhum Registro encontrado!">
                                                    <p:column
                                                        styleClass="centralizado"
                                                        style="width: 5%">
                                                        <p:commandButton icon="ui-icon-trash"
                                                                         styleClass="botao-transparente"
                                                                         onstart="aguarde.show()"
                                                                         oncomplete="aguarde.hide()"
                                                                         actionListener="#{exportacaoIPTUControlador.removerCadastro(cadastro)}"
                                                                         process="@this"
                                                                         update=":Formulario:primeiraTab:tabGeral:tabViewInscricao:panelImoveisIgnorados"/>
                                                    </p:column>

                                                    <p:column headerText="Inscrição Imobiliária">
                                                        <h:outputText value="#{cadastro.inscricaoCadastral}"/>
                                                    </p:column>
                                                    <p:column headerText="Setor">
                                                        <h:outputText
                                                            value="#{cadastro.setor}"/>
                                                    </p:column>
                                                    <p:column headerText="Lote">
                                                        <h:outputText
                                                            value="#{cadastro.lote}"/>
                                                    </p:column>
                                                    <p:column headerText="Quadra">
                                                        <h:outputText
                                                            value="#{cadastro.quadra}"/>
                                                    </p:column>
                                                    <p:column headerText="Bairro">
                                                        <h:outputText
                                                            value="#{cadastro.bairro}"/>
                                                    </p:column>
                                                    <p:column headerText="Logradouro">
                                                        <h:outputText
                                                            value="#{cadastro.logradouro}"/>
                                                    </p:column>
                                                    <p:column headerText="Número" style="width: 2%">
                                                        <h:outputText value="#{cadastro.numero}"/>
                                                    </p:column>
                                                </p:dataTable>

                                                <p:commandButton id="botao-relatorio"
                                                                 value="Relação de Imóveis Ignorados"
                                                                 icon="ui-icon-print"
                                                                 disabled="#{!exportacaoIPTUControlador.isCadastrosImobiliariosIgnorados()}"
                                                                 onclick="aguarde.show()"
                                                                 oncomplete="aguarde.hide()"
                                                                 styleClass="operacao mtop10"
                                                                 actionListener="#{exportacaoIPTUControlador.gerarRelatorio()}"
                                                                 title="Clique para gerar o Relatório"/>

                                            </p:outputPanel>

                                        </p:tab>

                                    </p:tabView>
                                </p:tab>
                            </p:tabView>
                        </p:panel>
                        <p:panel id="panel-rodape" styleClass="mtop10">
                            <p:commandButton value="Gerar Arquivo IPTU"
                                             onclick="aguarde.show()"
                                             update="@form"
                                             oncomplete="aguarde.hide(); iniciaExportacao();"
                                             styleClass="operacao prioritario"
                                             icon="ui-icon-download"
                                             rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso == null}"
                                             actionListener="#{exportacaoIPTUControlador.gerarArquivoIPTU()}">
                            </p:commandButton>

                            <p:outputPanel id="barra"
                                           rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso != null}">

                                <div class="alert alert-info centralizado" id="mensagemFim">
                                    <strong>#{exportacaoIPTUControlador.assistenteBarraProgresso.descricaoProcesso}</strong><br/>
                                    <span id="mgsAguarde">Aguarde!</span><br/>
                                    <span
                                        id="mgsAguarde2">Iniciado por #{exportacaoIPTUControlador.assistenteBarraProgresso.usuarioSistema.nome}</span><br/><br/>
                                    <div class="alinhamentoCentralizado">
                                        <h:outputText
                                            value="#{exportacaoIPTUControlador.assistenteBarraProgresso.porcentagemDoCalculo}">
                                            <f:convertNumber pattern="#,##0.00"/>
                                        </h:outputText>%
                                    </div>
                                    <div class="progress progress-striped active" id="barraProgresso">
                                        <div class="bar"
                                             style="width: #{exportacaoIPTUControlador.assistenteBarraProgresso.porcentagemDoCalculo}%;"></div>
                                    </div>
                                    <p:button value="Finalizar"
                                              styleClass="prioritario"
                                              rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso.processoExportacaoIPTU ne null}"
                                              icon="ui-icon-download"
                                              onclick="aguarde.show()"
                                              oncomplete="aguarde.hide();"
                                              href="/tributario/exportacao-iptu-anteriores/"/>

                                    <p:commandButton value="Abortar"
                                                     styleClass="icone_vermelho mrig05"
                                                     rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso.porcentagemDoCalculo lt 100}"
                                                     icon="ui-icon-cancel"
                                                     onclick="aguarde.show()"
                                                     update="@form"
                                                     oncomplete="aguarde.hide();"
                                                     actionListener="#{exportacaoIPTUControlador.cancelar()}"/>

                                    <p:commandButton value="Gerar Novo"
                                                     styleClass="padrao"
                                                     rendered="#{exportacaoIPTUControlador.assistenteBarraProgresso.processoExportacaoIPTU ne null}"
                                                     icon="ui-icon-refresh"
                                                     onclick="aguarde.show()"
                                                     update="@form"
                                                     oncomplete="aguarde.hide()"
                                                     actionListener="#{exportacaoIPTUControlador.recomecar()}"/>

                                    <p:poll interval="1"
                                            widgetVar="poll"
                                            autoStart="true"
                                            update=":Formulario:primeiraTab:panel-rodape"
                                            stop="#{exportacaoIPTUControlador.assistenteBarraProgresso.processoExportacaoIPTU ne null}"/>

                                </div>
                            </p:outputPanel>
                        </p:panel>
                    </p:tab>
                    <p:tab title="Exportações Anteriores"
                           id="salvasExportacaoTab">
                        <p:dataTable id="tabela-logs"
                                     rowStyleClass="#{empty rowlx or rowlx mod 2 ne 0 ? 'linha-selecionada' : 'vinteAltura'}"
                                     paginator="true"
                                     rows="10"
                                     paginatorTemplate="{CurrentPageReport} &lt;span class='titulo-tabela mrig10'>MENSAGENS&lt;/span> {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                     currentPageReportTemplate="{startRecord} - {endRecord} de {totalRecords}, Página: {currentPage}/{totalPages}"
                                     rowIndexVar="rowlx"
                                     styleClass="mtop10"
                                     value="#{exportacaoIPTUControlador.processos}"
                                     var="processo"
                                     emptyMessage="Nenhum registro encontrado.">
                            <p:column headerText="Data" styleClass="alinhamentoEsquerda">
                                <h:outputText value="#{processo.dataHora}">
                                    <f:convertDateTime pattern="dd/MM/yy 'às' HH:mm"/>
                                </h:outputText>
                            </p:column>
                            <p:column headerText="Usuário" styleClass="alinhamentoEsquerda">
                                <h:outputText value="#{processo.usuario.pessoaFisica.nome}"/>
                            </p:column>
                            <p:column headerText="Quantidade de Linhas" styleClass="alinhamentoEsquerda">
                                <h:outputText value="#{processo.quantidadeLinhas}"/>
                            </p:column>
                            <p:column headerText="Arquivos" styleClass="alinhamentoDireita">
                                <p:commandButton icon="ui-icon-download"
                                                 actionListener="#{exportacaoIPTUControlador.verArquivo(processo)}"
                                                 onclick="aguarde.show()"
                                                 update=":formArquivo"
                                                 oncomplete="aguarde.hide(); dialogArquivo.show()"/>
                            </p:column>
                        </p:dataTable>
                    </p:tab>
                </p:tabView>
            </p:panel>


        </h:form>
        <p:dialog modal="true" width="800" id="dlgArquivo" widgetVar="dialogArquivo"
                  header="Arquivos do Processo de Exportação de IPTUs">
            <h:form id="formArquivo">
                <fc:filesUploadWP
                    selecionado="#{exportacaoIPTUControlador.processoExportacaoIPTU}"
                    isTelaEditar="false"/>
                <p:commandButton icon="ui-icon-download"
                                 value="Baixar arquivo único"
                                 ajax="false"
                                 rendered="#{exportacaoIPTUControlador.hasArquivoParticionado()}">
                    <p:fileDownload value="#{exportacaoIPTUControlador.gerarArquivoUnico()}"/>
                </p:commandButton>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
</html>
