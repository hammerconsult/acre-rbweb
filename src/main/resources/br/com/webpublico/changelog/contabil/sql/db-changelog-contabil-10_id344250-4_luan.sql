DECLARE
texto CLOB := '{"consulta":"select\r\n    vw.codigo || '' - '' || vw.descricao as unidade,\r\n    sum(previsto) as previsto,\r\n    sum(realizado) as realizado\r\nfrom (\r\n         select lan.unidadeOrganizacional_id as idUnidade,\r\n                0 as previsto,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(lf.valor) else sum(lf.valor *-1) end as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                lan.dataLancamento as dataReferencia\r\n         from LANCRECEITAFONTE lf\r\n                  inner join LANCAMENTORECEITAORC lan on lf.lancReceitaOrc_id = lan.id\r\n                  inner join receitaloa rl on lan.receitaloa_id = rl.id\r\n                  inner join exercicio exe on lan.exercicio_id = exe.id\r\n         where exe.ano = $ANO\r\n         group by lan.dataLancamento, rl.operacaoReceita, lan.unidadeOrganizacional_id\r\n\r\n         union all\r\n         select rl.ENTIDADE_ID as idUnidade,\r\n                0 as previsto,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(lf.valor *-1 ) else sum(lf.valor) end as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                rr.dataEstorno as dataReferencia\r\n         from RECEITAORCFONTEESTORNO lf\r\n                  INNER JOIN RECEITAORCESTORNO rr ON lf.RECEITAORCESTORNO_id = rr.ID\r\n                  inner join receitaloa rl on rr.receitaloa_id = rl.id\r\n                  inner join exercicio exe on rr.exercicio_id = exe.id\r\n         where exe.ano = $ANO\r\n         group by rr.dataEstorno, rl.operacaoReceita, rl.ENTIDADE_ID\r\n\r\n         union all\r\n         select rl.ENTIDADE_ID as idUnidade,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(rlf.valor) else sum(rlf.valor *-1) end as previsto,\r\n                0 as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                rlf.dataRegistro as dataReferencia\r\n         from receitaloafonte rlf\r\n                  inner join receitaloa rl on rlf.receitaloa_id = rl.id\r\n                  inner join LOA loa ON rl.LOA_ID = loa.ID\r\n                  inner join LDO ldo ON loa.LDO_ID = ldo.ID\r\n                  inner join exercicio exe on ldo.EXERCICIO_ID = exe.id\r\n         where exe.ano = $ANO\r\n         group by rlf.dataRegistro, rl.operacaoReceita, rl.ENTIDADE_ID\r\n     ) dados\r\n         inner join vwhierarquiaorcamentaria vw on dados.idUnidade = vw.subordinada_id\r\n    where sysdate between vw.iniciovigencia and coalesce(vw.fimvigencia, sysdate)\r\n      and dados.idUnidade in (select UNIDADE_ID from UNIDADEPREFEITURAPORTAL where PREFEITURA_ID = $PREFEITURAPORTAL_ID)\r\n    $WHERE\r\ngroup by vw.codigo || '' - '' || vw.descricao\r\norder by vw.codigo || '' - '' || vw.descricao","count":"select count(1) from (select\r\n    vw.codigo || '' - '' || vw.descricao as unidade,\r\n    sum(previsto) as previsto,\r\n    sum(realizado) as realizado\r\nfrom (\r\n         select lan.unidadeOrganizacional_id as idUnidade,\r\n                0 as previsto,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(lf.valor) else sum(lf.valor *-1) end as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                lan.dataLancamento as dataReferencia\r\n         from LANCRECEITAFONTE lf\r\n                  inner join LANCAMENTORECEITAORC lan on lf.lancReceitaOrc_id = lan.id\r\n                  inner join receitaloa rl on lan.receitaloa_id = rl.id\r\n                  inner join exercicio exe on lan.exercicio_id = exe.id\r\n         where exe.ano = $ANO\r\n         group by lan.dataLancamento, rl.operacaoReceita, lan.unidadeOrganizacional_id\r\n\r\n         union all\r\n         select rl.ENTIDADE_ID as idUnidade,\r\n                0 as previsto,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(lf.valor *-1 ) else sum(lf.valor) end as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                rr.dataEstorno as dataReferencia\r\n         from RECEITAORCFONTEESTORNO lf\r\n                  INNER JOIN RECEITAORCESTORNO rr ON lf.RECEITAORCESTORNO_id = rr.ID\r\n                  inner join receitaloa rl on rr.receitaloa_id = rl.id\r\n                  inner join exercicio exe on rr.exercicio_id = exe.id\r\n         where exe.ano = $ANO\r\n         group by rr.dataEstorno, rl.operacaoReceita, rl.ENTIDADE_ID\r\n\r\n         union all\r\n         select rl.ENTIDADE_ID as idUnidade,\r\n                case when rl.operacaoReceita in (''RECEITA_CREDITOS_RECEBER_BRUTA'', ''RECEITA_DIRETAMENTE_ARRECADADA_BRUTA'', ''RECEITA_DIVIDA_ATIVA_BRUTA'') then sum(rlf.valor) else sum(rlf.valor *-1) end as previsto,\r\n                0 as realizado,\r\n                rl.operacaoReceita as operacaoReceita,\r\n                rlf.dataRegistro as dataReferencia\r\n         from receitaloafonte rlf\r\n                  inner join receitaloa rl on rlf.receitaloa_id = rl.id\r\n                  inner join LOA loa ON rl.LOA_ID = loa.ID\r\n                  inner join LDO ldo ON loa.LDO_ID = ldo.ID\r\n                  inner join exercicio exe on ldo.EXERCICIO_ID = exe.id\r\n         where exe.ano = $ANO\r\n         group by rlf.dataRegistro, rl.operacaoReceita, rl.ENTIDADE_ID\r\n     ) dados\r\n         inner join vwhierarquiaorcamentaria vw on dados.idUnidade = vw.subordinada_id\r\n    where sysdate between vw.iniciovigencia and coalesce(vw.fimvigencia, sysdate)\r\n      and dados.idUnidade in (select UNIDADE_ID from UNIDADEPREFEITURAPORTAL where PREFEITURA_ID = $PREFEITURAPORTAL_ID)\r\n    $WHERE\r\ngroup by vw.codigo || '' - '' || vw.descricao\r\norder by vw.codigo || '' - '' || vw.descricao) ","totalRegistros":15,"fields":[{"posicao":1,"descricao":"Unidade","columnName":"UNIDADE","columnValue":"UNIDADE","tipoAlinhamento":"ESQUERDA","totalizar":false,"link":null,"tipo":"STRING","tipoEnum":null,"valorPadrao":null,"escondido":false},{"posicao":2,"descricao":"Estimada (R$)","columnName":"PREVISTO","columnValue":"PREVISTO","tipoAlinhamento":"DIREITA","totalizar":true,"link":null,"tipo":"MONETARIO","tipoEnum":null,"valorPadrao":null,"escondido":false},{"posicao":3,"descricao":"Realizada (R$)","columnName":"REALIZADO","columnValue":"REALIZADO","tipoAlinhamento":"DIREITA","totalizar":true,"link":null,"tipo":"MONETARIO","tipoEnum":null,"valorPadrao":null,"escondido":false}],"pesquisaveis":[{"descricao":"Unidade","columnName":"vw.subordinada_id","columnValue":null,"tipo":"MULTI_SELECT","operacaoPadrao":null,"tipoEnum":null,"valorPadrao":"","tipoMultiSelect":"UNIDADE_ORCAMENTARIA"},{"descricao":"Operação da Receita","columnName":"operacaoReceita","columnValue":null,"tipo":"ENUM","operacaoPadrao":null,"tipoEnum":"br.com.webpublico.enums.OperacaoReceita","valorPadrao":[null,"RECEITA_DIRETAMENTE_ARRECADADA_BRUTA","RECEITA_CREDITOS_RECEBER_BRUTA","RECEITA_DIVIDA_ATIVA_BRUTA","DEDUCAO_RECEITA_RENUNCIA","DEDUCAO_RECEITA_RESTITUICAO","DEDUCAO_RECEITA_DESCONTO","DEDUCAO_RECEITA_FUNDEB","DEDUCAO_RECEITA_OUTRAS"]},{"descricao":"Período","columnName":"dataReferencia","columnValue":null,"tipo":"PERIODO","operacaoPadrao":null,"tipoEnum":null,"valorPadrao":""}]}';
BEGIN
update PAGINAPREFEITURAPORTAL set CONTEUDO = texto where NOME = 'Receita por Unidade' and CHAVE = 'receita-por-unidade';
END;
